<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF8">
    <title>PTAnywhere widget usage player</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <!-- JQuery -->
    <script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="bower_components/jquery-ui/jquery-ui.min.js"></script>
    <link type="text/css" rel="stylesheet" href="bower_components/jquery-ui/themes/smoothness/jquery-ui.min.css">
    <link type="text/css" rel="stylesheet" href="bower_components/jquery-ui/themes/smoothness/theme.css">

    <!-- Vis.js -->
    <script type="text/javascript" src="bower_components/vis/dist/vis.js"></script>
    <link type="text/css" rel="stylesheet" href="bower_components/vis/dist/vis.min.css">

    <!-- PTAnywhere -->
    <link type="text/css" rel="stylesheet" href="bower_components/widget-ui/css/widget.css">
    <script type="text/javascript" src="bower_components/widget-ui/js/locale/en.js"></script>
    <script type="text/javascript" src="bower_components/widget-ui/js/widget.js"></script>

    <!-- Replayer -->
    <link rel="stylesheet" href="css/replayer.css">
    <script type="text/javascript" src="js/replayer.js"></script>
    <script type="text/javascript" src="data/base_map.js"></script>
    <script type="text/javascript" src="data/vocabulary.js"></script>
    <script type="text/javascript">
        // Starts with (not yet supported by all browsers)
        String.prototype.startsWith = function(suffix) {
            return this.indexOf(suffix, 0) === 0;
        };

        function getId(url) {
            var els = url.split("/");
            var ret = els[els.length-1];
            if (ret.length!=0) return ret;
            return els[els.length-2];
        }

        $(function() {
            var htmlElements = {
                cbSessionId: 'registrations',
                btnSpeedId: 'speed',
                btnPlayPauseId: 'playPause',
                btnStopId: 'stop',
                sdrTimelineId: 'timeline',
                eventLogId: 'event-log',
            };
            replayer.create('../data/sessions', htmlElements);
            var widget = ptAnywhere.createNonInteractiveWidget('.widget', 'bower_components/widget-ui/images/', data, {});
            replayer.onStop(widget.reset);
            replayer.onStatement(function(statement) {
                console.log(statement);
            });
            replayer.onStatement(function(statement) {
                var dext = (statement.result===undefined)? null: statement.result.extensions;
                if (statement.verb.id===verb.create) {
                    if (statement.object.id.startsWith(devices.any)) {
                        var dId = getId(dext[extension.uri]);
                        widget.addDevice({ id: dId, group: dext[extension.type], label: dext[extension.name],
                                            x: dext[extension.position].x, y: dext[extension.position].y,
                                            url: dext[extension.uri] });
                    } else if (statement.object.id == activity.link) {
                        var ends = dext[extension.endpoints];
                        widget.connect(ends[0].device, ends[1].device);
                    }
                } else if (statement.verb.id===verb.delete) {
                    if (statement.object.id.startsWith(devices.any)) {
                        widget.removeDevice(dext[extension.name]);
                    } else if (statement.object.id == activity.link) {
                        var ends = dext[extension.endpoints];
                        widget.disconnect([ ends[0].device, ends[1].device ]);
                    }
                }
            });
        });
    </script>
  </head>
  <body>
    <div class="container">
      <h1>Replayer</h1>

      <div class="row">
        <div class="col-md-4">
          <p>Session to replay:
            <select id="registrations"></select>
            <button id="speed"></button>
            <button id="playPause">
              <span class="glyphicon glyphicon-play" aria-hidden="true"></span>
            </button>
            <button id="stop">
              <span class="glyphicon glyphicon-stop" aria-hidden="true"></span>
            </button>
          </p>
        </div>
        <div class="col-md-8">
          <span id="timeline"></span>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <div id="event-log" class="well"></div>
        </div>
        <div class="col-md-8">
          <div class="widget"></div>
        </div>
      </div>

      <div id="error-dialog" title="Error loading data"><p></p></div>
    </div>
  </body>
</html>

